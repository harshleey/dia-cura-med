generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  id               Int               @id @default(autoincrement())
  username         String            @unique
  email            String            @unique
  password         String?
  role             Role
  provider         String?
  providerId       String?
  ConsentAgreement ConsentAgreement?
  DoctorKyc        DoctorKyc?
  OtpToken         OtpToken[]
  PatientKyc       PatientKyc?
  UserSession      userSession[]

  notifications Notification[]

  messages Message[]

  chatParticipants ChatParticipant[]

  patientAppointments Appointment[] @relation("PatientAppointments")
  doctorAppointments  Appointment[] @relation("DoctorAppointments")

  doctorAvailabilities DoctorAvailability[]

  doctorRatings DoctorRating[] @relation("DoctorRatings")

  patientRatings DoctorRating[] @relation("PatientRatings")
}

model OtpToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model userSession {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      Users    @relation(fields: [userId], references: [id])
}

model PatientKyc {
  id                 Int               @id @default(autoincrement())
  userId             Int               @unique
  firstName          String?
  lastName           String?
  phoneNumber        String?
  dateOfBirth        DateTime?
  age                Int?
  gender             String?
  diabetesType       String?
  otherDiabetesType  String?
  diagnosisDate      DateTime?
  tracksInsulin      Boolean?
  insulinTherapy     String?
  glucoseUnit        String?
  measurementSystem  String?
  hasAllergies       Boolean?
  allergyDetails     String?
  currentMedications String[]
  currentStep        Int               @default(1)
  kycStatus          KycStatus         @default(PENDING)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  consentId          Int?
  consent            ConsentAgreement? @relation(fields: [consentId], references: [id])
  user               Users             @relation(fields: [userId], references: [id])
}

model DoctorKyc {
  id                    Int               @id @default(autoincrement())
  userId                Int               @unique
  firstName             String?
  lastName              String?
  email                 String?
  countryOfResidence    String?
  cityOfResidence       String?
  phoneNumber           String?
  dateOfBirth           DateTime?
  gender                String?
  specialization        String?
  hospitalIdCardUrl     String?
  medicalCertificateUrl String?
  nationalIdUrl         String?
  selfieUrl             String?
  consentId             Int?
  assessmentSent        Boolean?          @default(false)
  assessmentSentAt      DateTime?
  assessmentUploadUrl   String?
  assessmentScore       Int?
  kycStatus             KycStatus         @default(PENDING)
  currentStep           Int               @default(1)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  consent               ConsentAgreement? @relation(fields: [consentId], references: [id])
  user                  Users             @relation(fields: [userId], references: [id])
}

model ConsentAgreement {
  id               Int          @id @default(autoincrement())
  userId           Int          @unique
  consentAccepted  Boolean      @default(false)
  agreementVersion String?
  acceptedAt       DateTime?
  ipAddress        String?
  consentType      ConsentType?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  firstName        String?
  hodEmail         String?
  hodFirstName     String?
  hodLastName      String?
  hodPhone         String?
  lastName         String?
  user             Users        @relation(fields: [userId], references: [id])
  DoctorKyc        DoctorKyc[]
  PatientKyc       PatientKyc[]
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user Users @relation(fields: [userId], references: [id])
}

model ChatRoom {
  id           Int               @id @default(autoincrement())
  name         String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  messages     Message[]
  participants ChatParticipant[]
}

model ChatParticipant {
  id       Int      @id @default(autoincrement())
  roomId   Int
  userId   Int
  joinedAt DateTime @default(now())
  user     Users    @relation(fields: [userId], references: [id])
  room     ChatRoom @relation(fields: [roomId], references: [id])
}

model Message {
  id        Int      @id @default(autoincrement())
  roomId    Int
  senderId  Int
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  room   ChatRoom @relation(fields: [roomId], references: [id])
  sender Users    @relation(fields: [senderId], references: [id])
}

model Appointment {
  id            Int               @id @default(autoincrement())
  doctorId      Int
  patientId     Int
  date          DateTime
  time          String
  patientNote   String?
  status        AppointmentStatus @default(PENDING)
  medicalReport String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  doctor  Users @relation("DoctorAppointments", fields: [doctorId], references: [id])
  patient Users @relation("PatientAppointments", fields: [patientId], references: [id])

  doctorRatings DoctorRating[]
}

model DoctorAvailability {
  id        Int                      @id @default(autoincrement())
  doctorId  Int
  date      DateTime // e.g., 2025-02-12
  times     DoctorAvailabilityTime[]
  createdAt DateTime                 @default(now())

  doctor Users @relation(fields: [doctorId], references: [id])
}

model DoctorAvailabilityTime {
  id             Int    @id @default(autoincrement())
  availabilityId Int
  startTime      String
  endTime        String

  availability DoctorAvailability @relation(fields: [availabilityId], references: [id])
}

model DoctorRating {
  id            Int      @id @default(autoincrement())
  doctorId      Int
  patientId     Int
  appointmentId Int
  rating        Int
  comment       String?
  createdAt     DateTime @default(now())

  doctor      Users       @relation("DoctorRatings", fields: [doctorId], references: [id])
  patient     Users       @relation("PatientRatings", fields: [patientId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])
}

enum AppointmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  CONFIRMED
  RESCHEDULED
  RESCHEDULED_BY_DOCTOR
  RESCHEDULED_BY_PATIENT
  RESCHEDULE_CONFIRMED
  ONGOING
  COMPLETED
  MISSED
}

enum KycStatus {
  PENDING
  PASSED
  FAILED
  COMPLETED
  IN_PROGRESS
}

enum Role {
  PATIENT
  DOCTOR
  ADMIN
}

enum ConsentType {
  PATIENT_KYC
  DOCTOR_KYC
}

enum NotificationType {
  KYC_STATUS
  MESSAGE
  APPOINTMENT
  SYSTEM_ALERT
  REMINDER
  GENERAL
}
